name: ğŸ“Š RelatÃ³rio Semanal AutomÃ¡tico

on:
  # ExecuÃ§Ã£o automÃ¡tica todo domingo Ã s 21:00 UTC (18:00 BRT)
  schedule:
    - cron: '0 21 * * 0'
  
  # Permite execuÃ§Ã£o manual para testes
  workflow_dispatch:
    inputs:
      reason:
        description: 'Motivo da execuÃ§Ã£o manual'
        required: false
        default: 'ExecuÃ§Ã£o manual de teste'

# PermissÃµes necessÃ¡rias
permissions:
  contents: write  # Para criar commits e push
  issues: read     # Para ler issues do GitHub
  pull-requests: read

jobs:
  generate-weekly-report:
    runs-on: ubuntu-latest
    name: ğŸš€ Gerar RelatÃ³rio Semanal
    
    steps:
      - name: ğŸ“¥ Checkout do RepositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # HistÃ³rico completo para anÃ¡lise
          
      - name: âš™ï¸ Configurar Ambiente
        run: |
          echo "ğŸ”§ Configurando ambiente para geraÃ§Ã£o de relatÃ³rios..."
          sudo apt-get update
          sudo apt-get install -y bc jq
          
      - name: ğŸ“Š Executar Script de RelatÃ³rio Semanal  
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“ˆ Iniciando geraÃ§Ã£o do relatÃ³rio semanal..."
          cd /home/runner/work/carreira-infra-security/carreira-infra-security
          chmod +x scripts/weekly-report.sh
          ./scripts/weekly-report.sh
          
      - name: ğŸ“ Verificar Arquivos Gerados
        run: |
          echo "ğŸ” Verificando arquivos gerados..."
          ls -la reports/weekly/ || echo "DiretÃ³rio de relatÃ³rios ainda nÃ£o existe"
          ls -la latest-weekly-report || echo "Link simbÃ³lico ainda nÃ£o criado"
          
          if [ -f latest-weekly-report ]; then
            echo "âœ… RelatÃ³rio gerado com sucesso!"
            echo "ğŸ“Š PrÃ©via do relatÃ³rio:"
            head -20 latest-weekly-report
          else
            echo "âš ï¸ RelatÃ³rio nÃ£o foi gerado corretamente"
            exit 1
          fi
          
      - name: ğŸ“¤ Commit e Push dos RelatÃ³rios
        run: |
          echo "ğŸ’¾ Salvando relatÃ³rio no repositÃ³rio..."
          
          # Configurar Git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions - Weekly Report"
          
          # Adicionar arquivos gerados
          git add reports/
          git add latest-weekly-report
          
          # Verificar se hÃ¡ mudanÃ§as
          if git diff --staged --quiet; then
            echo "ğŸ“‹ Nenhuma mudanÃ§a detectada, nada para commitar"
          else
            # Commit com informaÃ§Ãµes da semana
            WEEK_NUM=$(date '+%V')
            CURRENT_DATE=$(date '+%d/%m/%Y')
            
            git commit -m "ğŸ“Š RelatÃ³rio Semanal AutomÃ¡tico - Semana ${WEEK_NUM} (${CURRENT_DATE})

            ğŸ¤– RelatÃ³rio gerado automaticamente pelo GitHub Actions
            ğŸ“… Data: ${CURRENT_DATE}
            ğŸ“ˆ Semana: ${WEEK_NUM}
            ğŸ”— Acesso: latest-weekly-report
            
            - âœ… Novo relatÃ³rio criado
            - ğŸ”— Links simbÃ³licos atualizados  
            - ğŸ“Š Dados extraÃ­dos dos KPIs atuais
            "
            
            # Push para o repositÃ³rio
            git push
            
            echo "âœ… RelatÃ³rio commitado e enviado com sucesso!"
          fi
          
      - name: ğŸ“‹ Resumo da ExecuÃ§Ã£o
        run: |
          echo "ğŸ“Š RESUMO DA EXECUÃ‡ÃƒO DO RELATÃ“RIO SEMANAL"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“… Data de execuÃ§Ã£o: $(date '+%d/%m/%Y %H:%M:%S')"
          echo "ğŸ“ˆ Semana do ano: $(date '+%V')"
          echo "ğŸ¤– Executado via: GitHub Actions"
          echo "ğŸ”„ PrÃ³xima execuÃ§Ã£o: PrÃ³ximo domingo Ã s 18:00 BRT"
          echo ""
          echo "ğŸ“ Arquivos gerados:"
          find reports/ -name "*.md" -type f | sort || echo "Nenhum arquivo encontrado"
          echo ""
          echo "ğŸ”— Link de acesso rÃ¡pido:"
          ls -la latest-weekly-report || echo "Link nÃ£o encontrado"
          echo ""
          echo "âœ… Workflow concluÃ­do com sucesso!"

      - name: ğŸš¨ NotificaÃ§Ã£o de Erro (se falhar)
        if: failure()
        run: |
          echo "âŒ ERRO na geraÃ§Ã£o do relatÃ³rio semanal"
          echo "ğŸ” Verifique os logs acima para detalhes"
          echo "ğŸ“ Considere executar manualmente para debug:"
          echo "   ./scripts/weekly-report.sh"
          exit 1
